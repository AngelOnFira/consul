---
layout: docs
page_title: Connect - Certificate Management
description: >-
  Consul can be used with Vault to manage and sign certificates. The Vault CA
  provider uses the Vault PKI secrets engine to generate and sign certificates.
---

# Vault as a Connect CA

Consul can be used with [Vault](https://www.vaultproject.io) to
manage and sign certificates.
The Vault CA provider uses the
[Vault PKI secrets engine](https://www.vaultproject.io/docs/secrets/pki)
to generate and sign certificates.

This page documents the specifics of the Vault CA provider.
Please read the [certificate management overview](/docs/connect/ca)
page first to understand how Consul manages certificates with configurable
CA providers.

-> **NOTE**: A Learn [tutorial](https://learn.hashicorp.com/tutorials/consul/vault-pki-consul-connect-ca?in=consul/vault-secure) is available to help you configure Vault as the Consul Connect service mesh Certification Authority.

## Requirements

Prior to using Vault as a CA provider for Consul, the following requirements
must be met:

- **Vault 0.10.3 or later.** Consul uses URI SANs in the PKI engine which
  were introduced in Vault 0.10.3. Prior versions of Vault are not
  compatible with Connect.

## Configuration

The Vault CA is enabled by setting the CA provider to `"vault"` and
setting the required configuration values.

The configuration may either be provided in the agent's configuration file using
the [`ca_provider`] and [`ca_config`] options, or configured using the
[`/connect/ca/configuration`] API endpoint.

Example configurations are shown below:

<CodeTabs heading="Connect CA configuration" tabs={["Agent configuration", "API"]}>

<CodeBlockConfig filename="/etc/consul.d/config.hcl" highlight="4,6-9">

```hcl
# ...
connect {
  enabled = true
  ca_provider = "vault"
  ca_config {
    address = "http://localhost:8200"
    token = "..."
    root_pki_path = "connect-root"
    intermediate_pki_path = "connect-intermediate"
  }
}
```

</CodeBlockConfig>

<CodeBlockConfig highlight="2,4-7">

```json
{
  "Provider": "vault",
  "Config": {
    "Address": "http://localhost:8200",
    "Token": "<token>",
    "RootPKIPath": "connect-root",
    "IntermediatePKIPath": "connect-intermediate"
  }
}
```

</CodeBlockConfig>

</CodeTabs>

The following table describes the configuration options for the Vault CA provider.

| API Key, Agent Key | Description | Type | Required |
| :-- | :-- | :-- | :-- |
| `Address`, <br/>`address` | Specifies the address of the Vault server. | String | Required |
| `Token`, <br/>`token` | Specifies an ACL token for accessing Vault. <br/>The value specified in the configuration is write-only and is not exposed when Vault reads the CA configuration. <br/>The token must be linked to a policy that provides access to the PKI path (see [Vault ACL Policies](#vault-acl-policies)). <br/>If the [`renewable`](https://www.vaultproject.io/api-docs/auth/token#renewable) flag is enabled for the token, Consul will periodically attempt to renew its lease after half of the duration has passed. <br/>_You must either provide a token or configure an `AuthMethod`, `auth_method`_. | String | Required unless `AuthMethod`, `auth_method` is configured. |  
| `AuthMethod`, <br/>`auth_method` | Specifies a Vault auth method for logging into Vault. <br/>If an auth method is configured, Consul obtains a new token from Vault when the current token can no longer be renewed. <br/>See [Auth Methods](#auth-methods) for details. | Map | Required unless `Token`, `token` is configured. |
| `RootPKIPath`, <br/>`root_pki_path` | Specifies the path to a PKI secrets engine so that Consul can access the root certificate. See [Root and Intermediate PKI Paths](#root-and-intermediate-pki-paths) for details. | String | Optional |
| `IntermediatePKIPath`, <br/>`intermediate_pki_path` | Specifies the path to a PKI secrets engine for the generated intermediate certificate. <br/>The certificate is signed by the secrets engine specified with the `RootPKIPath`, `root_pki_path` parameter. If the engine is not specified, Consul will attempt to mount and configure the engine automatically. <br/> When WAN Federation is enabled, every secondary datacenter must specify a unique `intermediate_pki_path`. <br/>See [Root and Intermediate PKI Paths](#root-and-intermediate-pki-paths) for additional information. | String | Required |
| `CAFile`, <br/>`ca_file` | Specifies a path to the CA certificate used for Vault communication. <br/>If unspecified, the default system CA bundle is used (refer to the documentation for your OS and version). | String | Optional |
| `CAPath`, <br/>`ca_path` | Specifies a path to a folder containing CA certificates to be used for Vault communication. If unspecified, the default system CA bundle is used (refer to the documentation for your OS and version). | String | Optional |
| `CertFile`, <br/>`cert_file` | Specifies the path to the certificate used for Vault communication. | String | Required when `KeyFile`, `key_file` is configured  |
| `KeyFile`, <br/>`key_file` | Specifies the path to the private key used for Vault communication. | String | Required when `CertFile`, `cert_file` is configured. |
| `TLSServerName`, <br/>`tls_server_name` | Specifies the SNI host when connecting to Vault via TLS. | String | Optional |
| `TLSSkipVerify`, <br/>`tls_skip_verify` | Enables SSL peer validation enforcement. Default is `false`. | Boolean | Optional |
| `Namespace`, <br/>`namespace` | Specifies the Vault namespace that the `Token` and PKI certificates are a part of. Requries Vault Enterprise (see [Namespaces](https://www.vaultproject.io/docs/enterprise/namespaces) for additional information). | String | Optional | 

### Auth Methods

Auth methods are components in Vault that perform authentication. They are responsible for assigning identity and a set of policies to a user. See [Vault Auth Methods](https://www.vaultproject.io/docs/auth) for information about configuring individual auth methods in Vault.

If an auth method is configured, Consul obtains a new token from Vault when the token can no longer be renewed.
Specify the following parameters to define an `AuthMethod` / `auth_method` object.

| API Key, Agent Key | Description | Type | Default |
| :-- | :-- | :-- | :-- |
| `Type`, <br/>`type` | Specifies the type of Vault auth method.| String | None |
| `MountPath`, <br/>`mount_path` | Specifies the mount path of the auth method. | String | `<AuthMethod.Type>` | 
| `Params`, <br/>`params` | Specifies the configuration parameters for the auth method. See [Vault Auth Methods](https://www.vaultproject.io/docs/auth) for information on how to configure the auth method you wish to use. <br/>If the Kubernetes auth method is specified, Consul reads the service account token from the default mount path `/var/run/secrets/kubernetes.io/serviceaccount/token` if the `jwt` parameter is not provided. | Map | `nil` |  

@include 'http_api_connect_ca_common_options.mdx'

## Root and Intermediate PKI Paths

The Vault CA provider uses two separately-configured paths with the [PKI secrets engines](https://www.vaultproject.io/docs/secrets/pki) for managing Connect certificates.

### Root PKI Paths

The `RootPKIPath`, `root_pki_path` parameter specifies the PKI path to the root certificate. 
Consul uses the root certificate to sign an intermediate certificate for each Consul datacenter, including the primary datacenter. 
When WAN Federation is enabled, each secondary datacenter must use the same Vault cluster and share the same `root_pki_path` with the primary datacenter.

If the path does not exist, Consul will mount a new PKI secrets engine at the specified path with the `RootCertTTL` value as the root certificate's TTL. 
Consul does not modify data within the root PKI path after the path has been mounted and initialized.

#### Root Certificate Expiration

If the `RootCertTTL` is not set, a [`max_lease_ttl`](https://www.vaultproject.io/api/system/mounts#max_lease_ttl) of 87600 hours, or 10 years is applied by default. The root certificate expires at the end of the specified period. 

#### Intermediate Certificate as the Primary CA

To use an intermediate certificate as the primary CA in Consul, initialize the `RootPKIPath` in Vault with a PEM bundle. 
The first certificate in the bundle must be the intermediate certificate that Consul will use as the primary CA. 
The last certificate in the bundle must be a root certificate. 

The bundle must contain a valid chain where each certificate is followed by the certificate that authorized it. See [using an external root CA](#using-an-external-root-ca) for instructions.

### Intermediate PKI Path

The [`IntermediatePKIPath` (`intermediate_pki_path`)](#intermediatepkipath) is
the PKI path used for storing the intermediate CA that is signed by the root certificate.
The intermediate certificate is used to sign all subsequent leaf certificates.
Consul periodically generates new intermediate certificates before the existing certificates
expire. Consul requires write access to this path in Vault. This path is managed
by Consul, and should not be mounted or initialized.

If the intermediate PKI path does not exist, Consul will attempt to mount and initialize it. This requires additional privileges by the Vault token.

### Using an External Root CA

To use an external root CA with the Vault provider, you must initialize the
`RootPKIPath` before configuring Consul.

1. Enable the PKI secrets engine at the path (`connect_root`) that will be used as
   `RootPKIPath`. Optionally you may also tune the path using `vault secrets tune`.

   ```shell-session
   $ vault secrets enable -path=connect_root pki
   ```

1. Create a [private certificate and a certificate signing request (CSR) in Vault](https://www.vaultproject.io/api-docs/secret/pki#generate-intermediate).

   ```shell-session
   $ vault write connect_root/intermediate/generate/internal
   ```

1. Use the external root CA to sign the CSR. The exact steps depend on where the root 
CA is stored.  If you are using vault to store the root CA use
[sign-intermediate](https://www.vaultproject.io/api-docs/secret/pki#sign-intermediate).

1. Create a pem bundle by concatenating the signed intermediate and the root CA that
   signed it.

   ```shell-session
   $ cat signed-intermediate.pem root-ca.pem > bundle.pem
   ```

1. Write the bundle.pem to the `RootPKIPath` with
[`set-signed`](https://www.vaultproject.io/api-docs/secret/pki#set-signed-intermediate).

   ```shell-session
   $ vault write connect_root/intermediate/set-signed certificate=@./bundle.pem
   ```


## Vault ACL Policies

If ACLs are enabled, implement the following ACL policies so that Consul can access Vault resources.

### Vault Managed PKI Paths

The following Vault policy allows Consul to use pre-existing PKI paths in Vault.
Consul is granted read-only access to the PKI mount points and the Root CA, but is
granted full control of the Intermediate or Leaf CA for Connect clients.

In this example the `RootPKIPath` is `connect_root` and the `IntermediatePKIPath`
is `connect_inter`. These values should be updated for your environment.

<CodeBlockConfig filename="vault-managed-pki-policy.hcl">

```hcl
# Existing PKI Mounts
path "/sys/mounts" {
  capabilities = [ "read" ]
}

path "/sys/mounts/connect_root" {
  capabilities = [ "read" ]
}

path "/sys/mounts/connect_inter" {
  capabilities = [ "read" ]
}

path "/connect_root/" {
  capabilities = [ "read" ]
}

path "/connect_root/root/sign-intermediate" {
  capabilities = [ "update" ]
}

path "/connect_inter/*" {
  capabilities = [ "create", "read", "update", "delete", "list" ]
}

path "auth/token/renew-self" {
	capabilities = [ "update" ]
}

path "auth/token/lookup-self" {
	capabilities = [ "read" ]
}
```

</CodeBlockConfig>

### Consul Managed PKI Paths

The following Vault policy allows Consul to create and manage the PKI paths in Vault.
Consul is granted the ability to create the PKI mount points and given full
control of the Root and Intermediate or Leaf CA for Connect clients.

In this example the `RootPKIPath` is `connect_root` and the `IntermediatePKIPath`
is `connect_inter`. These values should be updated for your environment.

<CodeBlockConfig filename="consul-managed-pki-policy.hcl">

```hcl
# Consul Managed PKI Mounts
path "/sys/mounts" {
  capabilities = [ "read" ]
}

path "/sys/mounts/connect_root" {
  capabilities = [ "create", "read", "update", "delete", "list" ]
}

path "/sys/mounts/connect_inter" {
  capabilities = [ "create", "read", "update", "delete", "list" ]
}

path "/connect_root/*" {
  capabilities = [ "create", "read", "update", "delete", "list" ]
}

path "/connect_inter/*" {
  capabilities = [ "create", "read", "update", "delete", "list" ]
}
```

</CodeBlockConfig>

<!-- Reference style links -->
[`ca_config`]: /docs/agent/options#connect_ca_config
[`ca_provider`]: /docs/agent/options#connect_ca_provider
[`/connect/ca/configuration`]: /api-docs/connect/ca#update-ca-configuration
