---
layout: docs
page_title: Connect - Certificate Management
description: >-
  Consul can be used with Vault to manage and sign certificates. The Vault CA
  provider uses the Vault PKI secrets engine to generate and sign certificates.
---

# Vault as a Connect CA

Consul can be used with [Vault](https://www.vaultproject.io) to
manage and sign certificates.
The Vault CA provider uses the
[Vault PKI secrets engine](https://www.vaultproject.io/docs/secrets/pki)
to generate and sign certificates.

This page documents the specifics of the Vault CA provider.
Please read the [certificate management overview](/docs/connect/ca)
page first to understand how Consul manages certificates with configurable
CA providers.

-> **Tutorial**: A Learn [tutorial](https://learn.hashicorp.com/tutorials/consul/vault-pki-consul-connect-ca?in=consul/vault-secure) is available to help you configure Vault as the Consul Connect service mesh Certification Authority.

## Requirements

Prior to using Vault as a CA provider for Consul, the following requirements
must be met:

- **Vault 0.10.3 or later.** Consul uses URI SANs in the PKI engine which
  were introduced in Vault 0.10.3. Prior versions of Vault are not
  compatible with Connect.

## Configuration

The Vault CA is enabled by setting the CA provider to `"vault"` and
setting the required configuration values.

The configuration may either be provided in the agent's configuration file using
the [`ca_provider`] and [`ca_config`] options, or configured using the
[`/connect/ca/configuration`] API endpoint.

Example configurations are shown below:

<CodeTabs heading="Connect CA configuration" tabs={["Agent configuration", "API"]}>

<CodeBlockConfig filename="/etc/consul.d/config.hcl" highlight="4,6-9">

```hcl
# ...
connect {
  enabled = true
  ca_provider = "vault"
  ca_config {
    address = "http://localhost:8200"
    token = "<Vault token>"
    root_pki_path = "connect-root"
    intermediate_pki_path = "connect-intermediate"
  }
}
```

</CodeBlockConfig>

<CodeBlockConfig highlight="2,4-7">

```json
{
  "Provider": "vault",
  "Config": {
    "Address": "http://localhost:8200",
    "Token": "<Vault token>",
    "RootPKIPath": "connect-root",
    "IntermediatePKIPath": "connect-intermediate"
  }
}
```

</CodeBlockConfig>

</CodeTabs>

The configuration options are listed below.

-> **Option Naming Conventions**:
   The naming of Connect CA configuration options differs between the two configuration methods:
   an [API endpoint](/api-docs/connect/ca#update-ca-configuration) and
   the [agent configuration file](/docs/agent/options#connect_ca_config).
   The sections below show both option names in the form
   `<API Call Option Name> / <Configuration File Option Name>`.

-> **Using Vault Namespaces?**
  If a specified Vault authentication mechanism or PKI path exists in a
  [Vault Namespace](https://www.vaultproject.io/docs/enterprise/namespaces),
  refer to
  [configuration with Vault Namespaces](#configuration-with-vault-namespaces).

#### Vault Resource Locations

- `Address` / `address` (`string: <required>`) - The address of the Vault
  server.

- `RootPKIPath` / `root_pki_path` (`string: <required>`) -
  The path to a PKI secrets engine that will act as the primary Connect CA in Consul.

  If a PKI secrets engine already exists at this path,
  it can be **either a root or an intermediate certificate**.
  Using an intermediate certificate can improve security by allowing an organization's
  trusted root CA to be stored outside of Vault.
  To use an intermediate certificate, initialize the
  `RootPKIPath` in Vault with a PEM bundle. The first certificate in the bundle
  must be the intermediate certificate that Consul will use as the primary CA.
  The last certificate in the bundle must be a root certificate. The bundle
  must contain a valid chain, where each certificate is followed by the certificate
  that authorized it. To learn more, refer to this tutorial on
  [building an intermediate CA with Vault](https://learn.hashicorp.com/tutorials/vault/pki-engine).

  If a PKI secrets engine **does not exist at this path**,
  Consul will mount a new PKI secrets engine at the specified path with the
  [`RootCertTTL`](#rootcertttl) value as the root certificate's TTL.
  If the [`RootCertTTL`](#rootcertttl) is not set,
  a [`max_lease_ttl`](https://www.vaultproject.io/api/system/mounts#max_lease_ttl)
  of 87600 hours, or 10 years, is applied by default as of Consul 1.11 and later.
  The root certificate will expire at the end of the specified period.

  **When WAN Federation is enabled**,
  each secondary datacenter must use the same Vault cluster and share the same `root_pki_path`
  with the primary datacenter.

  **If the path exists in a Vault Namespace**,
  refer to the [configuration with Vault Namespaces](#configuration-with-vault-namespaces).

- `IntermediatePKIPath` / `intermediate_pki_path` (`string: <required>`) -
  The path to a PKI secrets engine for the generated intermediate certificate.

  This certificate will be signed by the configured root PKI path.

  If a PKI secrets engine **does not exist at this path**,
  Consul will attempt to mount and configure one automatically.

  **When WAN Federation is enabled**,
  every secondary datacenter must specify a unique `intermediate_pki_path`.

  **If the path exists in a Vault Namespace**,
  refer to the [configuration with Vault Namespaces](#configuration-with-vault-namespaces).

- `Namespace` / `namespace` (`string: <optional>`) -
  The Vault Namespace from which the specified Vault authentication mechanism
  ([`Token`](#token) or [`AuthMethod`](#authmethod)) and PKI secrets engine paths
  ([`RootPKIPath`](#rootpkipath) and [`IntermediatePKIPath`](#intermediatepkipath)) are accessed.
  Refer to the [configuration with Vault Namespaces](#configuration-with-vault-namespaces)
  for more details.

#### Vault Authentication

You must provide either a Vault token or auth method to authenticate with Vault
that grants the [necessary privileges](#vault-acl-policies) for the specified
[Root](#rootpkipath) and [Intermediate](#intermediatepkipath) PKI paths.

If the authentication mechanism exists within a Vault namespace,
refer to the [configuration with Vault Namespaces](#configuration-with-vault-namespaces).

- `Token` / `token` (`string: ""`) - A Vault token for accessing Vault.
  This is write-only and will not be exposed when reading the CA configuration.
  If the Vault token has the [renewable](https://www.vaultproject.io/api-docs/auth/token#renewable)
  flag set, Consul will attempt to renew its lease periodically after half the
  duration has expired.

- `AuthMethod` / `auth_method` (`map: nil`) - A Vault auth method for accessing Vault.
  Upon logging in with this Vault auth method, Consul will receive a Vault token.
  Consul will automatically obtain a new token from Vault when the token can no longer be renewed.

  Please see [Vault Auth Methods](https://www.vaultproject.io/docs/auth) for more information
  on how to configure individual Vault auth methods.
  All auth methods must include:

   - `Type`/ `type` (`string: ""`) - The type of Vault auth method.

   - `MountPath`/ `mount_path` (`string: <AuthMethod.Type>`) - The mount path of the auth method.
      If not provided the auth method type will be used as the mount path.

   - `Params`/`params` (`map: nil`) - The parameters to configure the auth method. Please see
    [Vault Auth Methods](https://www.vaultproject.io/docs/auth) for information on how to configure the
    auth method you wish to use. If using the Kubernetes auth method,
    Consul will read the service account token from the
    default mount path `/var/run/secrets/kubernetes.io/serviceaccount/token` if the `jwt` parameter
    is not provided.

#### Vault TLS Communication

- `CAFile` / `ca_file` (`string: ""`) - Specifies an optional path to the CA
  certificate used for Vault communication. If unspecified, this will fallback
  to the default system CA bundle, which varies by OS and version.

- `CAPath` / `ca_path` (`string: ""`) - Specifies an optional path to a folder
  containing CA certificates to be used for Vault communication. If
  unspecified, this will fallback to the default system CA bundle, which
  varies by OS and version.

- `CertFile` / `cert_file` (`string: ""`) - Specifies the path to the
  certificate used for Vault communication. If this is set, then you also need to
  set `key_file`.

- `KeyFile` / `key_file` (`string: ""`) - Specifies the path to the private
  key used for Vault communication. If this is set, then you also need to set
  `cert_file`.

- `TLSServerName` / `tls_server_name` (`string: ""`) - Specifies an optional
  string used to set the SNI host when connecting to Vault via TLS.

- `TLSSkipVerify` / `tls_skip_verify` (`bool: false`) - Specifies if SSL peer
  validation should be enforced.

@include 'http_api_connect_ca_common_options.mdx'

## Root and Intermediate PKI Paths

The Vault CA provider uses two separately configured
[PKI secrets engines](https://www.vaultproject.io/docs/secrets/pki)
for managing Connect certificates.

The `RootPKIPath` is the PKI engine for the root certificate. Consul will
use this root certificate to sign the intermediate certificate. Consul will
never attempt to write or modify any data within the root PKI path.

The `IntermediatePKIPath` is the PKI engine used for storing the intermediate
signed with the root certificate. The intermediate is used to sign all leaf
certificates and Consul may periodically generate new intermediates for
automatic rotation. Therefore, Consul requires write access to this path.

If either path does not exist, then Consul will attempt to mount and
initialize it. This requires additional privileges by the Vault token in use.
If the paths already exist, Consul will use them as configured.

## Vault ACL Policies

### Vault Managed PKI Paths

The following Vault policy allows Consul to use pre-existing PKI paths in Vault.
Consul is granted read-only access to the PKI mount points and the Root CA, but is
granted full control of the Intermediate or Leaf CA for Connect clients.

In this example the `RootPKIPath` is `connect_root` and the `IntermediatePKIPath`
is `connect_inter`. These values should be updated for your environment.

<CodeBlockConfig filename="vault-managed-pki-policy.hcl">

```hcl
# Existing PKI Mounts
path "/sys/mounts" {
  capabilities = [ "read" ]
}

path "/sys/mounts/connect_root" {
  capabilities = [ "read" ]
}

path "/sys/mounts/connect_inter" {
  capabilities = [ "read" ]
}

path "/connect_root/" {
  capabilities = [ "read" ]
}

path "/connect_root/root/sign-intermediate" {
  capabilities = [ "update" ]
}

path "/connect_inter/*" {
  capabilities = [ "create", "read", "update", "delete", "list" ]
}

path "auth/token/renew-self" {
	capabilities = [ "update" ]
}

path "auth/token/lookup-self" {
	capabilities = [ "read" ]
}
```

</CodeBlockConfig>

### Consul Managed PKI Paths

The following Vault policy allows Consul to create and manage the PKI paths in Vault.
Consul is granted the ability to create the PKI mount points and given full
control of the Root and Intermediate or Leaf CA for Connect clients.

In this example the `RootPKIPath` is `connect_root` and the `IntermediatePKIPath`
is `connect_inter`. These values should be updated for your environment.

<CodeBlockConfig filename="consul-managed-pki-policy.hcl">

```hcl
# Consul Managed PKI Mounts
path "/sys/mounts" {
  capabilities = [ "read" ]
}

path "/sys/mounts/connect_root" {
  capabilities = [ "create", "read", "update", "delete", "list" ]
}

path "/sys/mounts/connect_inter" {
  capabilities = [ "create", "read", "update", "delete", "list" ]
}

path "/connect_root/*" {
  capabilities = [ "create", "read", "update", "delete", "list" ]
}

path "/connect_inter/*" {
  capabilities = [ "create", "read", "update", "delete", "list" ]
}
```

</CodeBlockConfig>

## Configuration with Vault Namespaces

[Vault Namespaces](https://www.vaultproject.io/docs/enterprise/namespaces)
are a multi-tenancy feature of Vault Enterprise that allow
multiple, isolated Vault environments within a single Vault infrastructure.

This Connect CA provider can access Vault tokens, auth methods, and PKI secrets engines
that exist within the same or different Vault Namespaces.

The [`Namespace`](#namespace) option is used as the `X-Vault-Namespace` header
for all API requests made by this CA provider to Vault.
All Vault namespaces included in paths are relative to the value of this header.
For more details on how paths to namespaced resources can be specified,
refer to the [Vault Namespace usage documentation](https://www.vaultproject.io/docs/enterprise/namespaces#usage).

The PKI path options ([`RootPKIPath`](#rootpkipath) and [`IntermediatePKIPath`](#intermediatepkipath)
both support including a Vault Namespace in the path.
However, the Vault authentication options ([`Token`](#token) and [`AuthMethod`](#authmethod))
do not allow specifying a Vault Namespace in their configuration.

**If using an authentication mechanism that exists within a non-root Vault Namespace**:
- set the [`Namespace`](#namespace) option to the Vault authentication mechanism's Namespace, and
- `RootPKIPath` and `IntermediatePath` must be in that same Namespace or a child Namespace;
  the relative path to a child Namespace must be included in the path

### Example 1: PKI Paths in Same Namespace

Consider the following setup of Vault resources and their namespaces:

| Vault Resource                       | Belongs to Vault Namespace | Resource Name              |
| ------------------------------------ | -------------------------- | -------------------------- |
| `Token`                              | root                       | N/A                        |
| `RootPKIPath` (Primary CA)           | `ns-consul`                | `connect-root`             |
| `IntermediatePKIPath` (Secondary CA) | `ns-consul`                | `connect-intermediate-dc1` |

The correct Connect CA configuration for this setup is:

<CodeTabs heading="Connect CA configuration" tabs={["Agent configuration", "API"]}>

<CodeBlockConfig filename="/etc/consul.d/config.hcl" highlight="7-9">

```hcl
# ...
connect {
  enabled = true
  ca_provider = "vault"
  ca_config {
    address = "http://localhost:8200"
    token = "<Vault token>"
    root_pki_path = "ns-consul/connect-root"
    intermediate_pki_path = "ns-consul/connect-intermediate-dc1"
  }
}
```

</CodeBlockConfig>

<CodeBlockConfig highlight="5-7">

```json
{
  "Provider": "vault",
  "Config": {
    "Address": "http://localhost:8200",
    "Token": "<Vault token>",
    "RootPKIPath": "ns-consul/connect-root",
    "IntermediatePKIPath": "ns-consul/connect-intermediate-dc1"
  }
}
```

</CodeBlockConfig>

</CodeTabs>

-> **Why the Namespace option isn't used**:
  In this case, the [`Namespace`](#namespace) option cannot be set to `ns-consul/` because
  the Vault `Token` is in the root Vault Namespace.

### Example 2: Token in Vault Namespace, PKI Paths in Different Namespaces

Consider the following setup of Vault resources and their namespaces:

| Vault Resource                       | Belongs to Vault Namespace     | Resource Name              |
| ------------------------------------ | ------------------------------ | -------------------------- |
| `Token`                              | `ns-consul-root`               | N/A                        |
| `RootPKIPath` (Primary CA)           | `ns-consul-root`               | `connect-root`             |
| `IntermediatePKIPath` (Secondary CA) | `ns-consul-root/ns-consul-dc1` | `connect-intermediate-dc1` |

The correct Connect CA configuration for this setup is:

<CodeTabs heading="Connect CA configuration" tabs={["Agent configuration", "API"]}>

<CodeBlockConfig filename="/etc/consul.d/config.hcl" highlight="7-10">

```hcl
# ...
connect {
  enabled = true
  ca_provider = "vault"
  ca_config {
    address = "http://localhost:8200"
    namespace = "ns-consul-root/"
    token = "<Vault token>"
    root_pki_path = "connect-root"
    intermediate_pki_path = "ns-consul-dc1/connect-intermediate-dc1"
  }
}
```

</CodeBlockConfig>

<CodeBlockConfig highlight="5-8">

```json
{
  "Provider": "vault",
  "Config": {
    "Address": "http://localhost:8200",
    "Namespace": "ns-consul-root/"
    "Token": "<Vault token>",
    "RootPKIPath": "connect-root",
    "IntermediatePKIPath": "ns-consul-dc1/connect-intermediate-dc1"
  }
}
```

</CodeBlockConfig>

</CodeTabs>

<!-- Reference style links -->
[`ca_config`]: /docs/agent/options#connect_ca_config
[`ca_provider`]: /docs/agent/options#connect_ca_provider
[`/connect/ca/configuration`]: /api-docs/connect/ca#update-ca-configuration
