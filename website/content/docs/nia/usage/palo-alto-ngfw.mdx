---
page_title: Automate Palo Alto NGFW with Consul-Terraform-Sync 
description: Use Consul-Terraform-Sync (CTS) to automatically configure your Palo Alto Next-Generation Firewall's (NGFW) dynamic address groups when your Consul service changes.
---

# Automate Palo Alto NGFW with Consul-Terraform-Sync

This topic describes how to automatically configure your Palo Alto Next-Generation Firewall's (NGFW) dynamic address group using Terraform and Consul.

## Overview

You can use Consul-Terraform-Sync (CTS) for network infrastructure automation (NIA). This enables you to automatically update your infrastructure and network devices using Terraform whenever your service networking control plane (Consul) changes.

The following image shows the basic architecture of an NIA setup with Palo Alto NGFW.

![NIA CTS with Palo Alto NGFW architecture diagram](/img/nia/palo_alto_architecture_diagram.png)
 
Complete the following steps to configure your NGFW:

1. Configure a dynamic address group (DAG)
1. Register your Consul services
1. Configure CTS
1. Start CTS
1. Verify NIA workflow

## Background

The Palo Alto NGFW and Panorama are compatible with various cloud providers, hypervisors, and containers. Combined with the extreme portability of Consul and Terraform, CTS makes the workflow portable with minimal changes, in any platform, increasing your flexibility and simplifying workflow migration across different solutions.

The [`dag-nia`](https://registry.terraform.io/modules/PaloAltoNetworks/dag-nia/panos/latest) Terraform module, a Palo Alto Networks managed Terraform module for CTS, lets operators automate their network infrastructure by dynamically configuring address groups and dynamic address tags. Once configured, CTS will register or deregister address group IP tags based on changes to the respective services in Consul.

The following diagram shows an example network infrastructure automation (NIA) workflow with Terraform, Consul, CTS, and Palo Alto NGFW.

![NIA CTS with PAN NGFW workflow](/img/nia/palo_alto_ngfw_workflow.png)

This topic assumes you are familiar with the standard Consul workflow and CTS. If you are unfamiliar with these topics, reference their respective tutorials to learn more.

- Complete the [Get Started with Consul on VMs](/consul/tutorials/get-started-vms) or [Get Started with Consul on Kubernetes](/consul/tutorials/get-started-kubernetes) tutorials to learn more about Consul.
- Complete the [Network Infrastructure Automation with Consul-Terraform-Sync Intro](/consul/tutorials/network-infrastructure-automation/consul-terraform-sync-intro) tutorial to learn more about CTS.

## Requirements

1. A [Palo Alto NGFW](https://www.paloaltonetworks.com/network-security/next-generation-firewall) or other PAN OS-based device. The PAN OS-based network device must use a dynamic address group (DAG). 
1. A [Consul datacenter](#consul) for service networking and service mesh
1. A server with [Consul-Terraform-Sync (CTS)](#consul-terraform-sync) installed. This server must be able to communicate with the NGFW and the Consul datacenter.

  ~> **Compatibility Note:** CTS requires Terraform 0.13 or later. You can either install Terraform before starting CTS or let the CTS install a compatible Terraform version for you.

1. Application servers running a service. You must register these servers to Consul. Refer to [Register Services with Service Definitions](/consul/docs/discover/services) for instructions.

### Configure NGFW dynamic address group

Configure your Palo Alto NGFW dynamic address group (DAG) by choosing **Dynamic** from the **Type** field in the Palo Alto NGFW interface. CTS will automatically register or deregister the web server resources to the DAG. Refer to the [Palo Alto documentation](https://docs.paloaltonetworks.com/network-security/security-policy/objects/address-groups/dynamic-address-groups) for additional information about dynamic address groups. The following minimal example defines a DAG named `web` with a matching selection for `'web'`.

![Palo Alto NGFW Dynamic Address Group](/img/nia/palo_alto_ngfw_dynamic_address_group.png)

## Register your Consul services

Before you can use CTS, you must register your services to Consul.

1. For each service, create a service configuration file with a health check. The service name must match the `service-group` name defined on the Palo Alto NGFW. Refer to the [service registration usage docs](/consul/docs/discovery/services) to learn how to register Consul services. The following example registers a service called `web` on port `80` and enables a health check named `web TCP check`:.

  <Tabs>
  <Tab heading="HCL" group="hcl">

  Create a service configuration file with the following details named `web.hcl`.

  <CodeBlockConfig filename="web.hcl">

  ```hcl
  service {
    name = "web"
    port = 80
    check {
      id = "web"
      name = "web TCP check"
      tcp = "localhost:80"
      interval = "10s"
      timeout = "1s"
    }
  }
  ```

  </CodeBlockConfig>

  </Tab>
  <Tab heading="JSON" group="json">

  Create a service configuration file with the following details named `web.json`.

  <CodeBlockConfig filename="web.json">

  ```json
  {
    "service": {
      "name": "web",
      "port": 80,
      "checks": [
        {
          "id": "web",
          "name": "web TCP Check",
          "tcp": "localhost:80",
          "interval": "10s",
          "timeout": "1s"
        }
      ]
    }
  }
  ```
  </CodeBlockConfig>

  </Tab>
  </Tabs>

1. Register the service with Consul.

  <Tabs>
  <Tab heading="HCL" group="hcl">

  ```shell-session
  $ consul services register web.hcl
  ```

  </Tab>
  <Tab heading="JSON" group="json">

  ```shell-session
  $ consul services register web.json
  ```

  </Tab>
  </Tabs>

Reload the Consul dashboard to find the newly registered `web` services.

![Consul services tab for web](/img/nia/palo_alto_ngfw_consul_services_web.png)

## Configure CTS

CTS requires access to the Consul catalog. If you're using Consul as a Terraform backend, you will also need privileges to store the Terraform state into Consul's key-value (KV) store.

In production environments, we recommend enabling access control lists (ACLs) on Consul. In order for CTS to retrieve information from Consul, it must pass a token in its configuration. Refer to the [production CTS tutorial](/consul/tutorials/network-infrastructure-automation/consul-terraform-sync-secure) for more information about ACL tokens and an example of a secure CTS configuration.

Create a CTS configuration file that defines a set of tasks to run when a service is registered or removed from Consul. In the following example, CTS uses the `consul` and `panos` providers to run the `Create_DAG_on_PANOS1` task when the `web` service changes.

<CodeBlockConfig filename="tasks.hcl">

```hcl
log_level = "info"

driver "terraform" {
  log = true
  required_providers {
    panos = {
      source = "PaloAltoNetworks/panos"
    }
  }
}

consul {
  address = "localhost:8500"
}

terraform_provider "panos" {
  alias = "panos1" 
  address  = "10.64.4.104"
  username = "admin"
}

task {
  name = "Create_DAG_on_PANOS1"
  description = "Automate Dynamic Address Groups based on service definition"
  providers = ["panos.panos1"]
  module = "github.com/PaloAltoNetworks/terraform-panos-dag-nia"
  condition "services" {
    names = ["web"]
  }
  variable_files = []
}
```

</CodeBlockConfig>

The `driver` block defines all Terraform providers required to execute the task. In the following example, the `PaloAltoNetworks/panos` provider is required.

<CodeBlockConfig filename="tasks.hcl" hideClipboard highlight="5">

```hcl
driver "terraform" {
  log = true
  required_providers {
    panos = {
      source = "PaloAltoNetworks/panos"
    }
  }
}
```

</CodeBlockConfig>

The `terraform_provider` specifies the parameters to interact with the Palo Alto NGFW.

~> **Security Note:** In a production environment, we recommend separating any sensitive credentials from the CTS configuration files and loading them dynamically using environment variables, Consul KV, or HashiCorp Vault. Refer to the [Terraform Registry](https://registry.terraform.io/providers/PaloAltoNetworks/panos/latest/docs#argument-reference) for a full set of provider arguments.

<CodeBlockConfig filename="tasks.hcl" hideClipboard>

```hcl
terraform_provider "panos" {
  alias = "panos1" 
  address  = "10.64.4.104"
  username = "admin"
}
```

</CodeBlockConfig>

The `task` block defines a task for CTS to run when specific Consul services change.

- `name` defines the task name.
- `providers` defines the providers this task uses. In this case, the previously defined `panos.panos1` provider (aliased).
- `module` defines the path to the Palo Alto Terraform NIA module. This module lets Terraform dynamically manage address group configuration when there are changes to specific Consul services.
- `condition "services"` defines the Consul services, when changed, would trigger this CTS task. The names must match the name of the Consul service you want to trigger the task.

<CodeBlockConfig filename="tasks.hcl" hideClipboard>

```hcl
task {
  name = "Create_DAG_on_PANOS1"
  description = "Automate Dynamic Address Groups based on service definition"
  providers = ["panos.panos1"]
  module = "github.com/PaloAltoNetworks/terraform-panos-dag-nia"
  condition "services" {
    names = ["web"]
  }
  variable_files = []
}
```

</CodeBlockConfig>

For more details about the configuration, refer to the [CTS configuration docs](/consul/docs/nia/configuration). For more details on the Terraform NIA module for PAN-OS devices, refer to its [Terraform Registry](https://registry.terraform.io/modules/PaloAltoNetworks/dag-nia/panos/latest) or [GitHub repository](https://github.com/PaloAltoNetworks/terraform-panos-dag-nia).

## Start CTS

Run the the `consul-terraform-sync start` command to start CTS and perform the following operations:

- download and install the Terraform providers and modules according to the configuration file you have provided (`tasks.hcl`),
- create Terraform files for the defined tasks, and 
- connect to Consul.

```shell-session
$ consul-terraform-sync start -config-file=tasks.hcl
[INFO]  cli: v0.6.0 (7f0d7ba)
[INFO]  cli: running controller in daemon mode
[INFO]  cli: setting up controller: type=readwrite
[INFO]  ctrl: initializing Consul client and testing connection
[INFO]  driver.terraform: install terraform: install_path=/consul-terraform-sync/config
[INFO]  driver.terraform: successfully installed terraform
## ...
[INFO] running Terraform command: /consul-terraform-sync/config/terraform init -no-color -force-copy -input=false -backend=true -get=true -upgrade=false
Initializing modules...
Downloading github.com/PaloAltoNetworks/terraform-panos-dag-nia for Create_DAG_on_PANOS1...
- Create_DAG_on_PANOS1 in .terraform/modules/Create_DAG_on_PANOS1

Initializing the backend...

Successfully configured the backend "consul"! Terraform will automatically
use this backend unless the backend configuration changes.

Initializing provider plugins...
- Finding paloaltonetworks/panos versions matching "~> 1.8.3"...
- Installing paloaltonetworks/panos v1.8.3...
- Installed paloaltonetworks/panos v1.8.3 (signed by a HashiCorp partner, key ID D5D93F98EFA33E83)
## ...
Terraform has been successfully initialized!

[INFO] running Terraform command: /consul-terraform-sync/config/terraform workspace new -no-color Create_DAG_on_PANOS1
Created and switched to workspace "Create_DAG_on_PANOS1"!
## ...
[INFO]  ctrl: driver initialized
[INFO]  ctrl: executing all tasks once through
[INFO]  ctrl: executing task: task_name=Create_DAG_on_PANOS1
[INFO] running Terraform command: /consul-terraform-sync/config/terraform apply -no-color -auto-approve -input=false -var-file=terraform.tfvars -var-file=providers.tfvars -lock=true -parallelism=10 -refresh=true

Terraform used the selected providers to generate the following execution plan. Resource actions are
indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # module.Create_DAG_on_PANOS1.panos_ip_tag.this["web.web-1.dc1"] will be created
  + resource "panos_ip_tag" "this" {
      + id   = (known after apply)
      + ip   = "10.88.0.102"
      + tags = [
          + "web",
        ]
      + vsys = "vsys1"
    }

  # module.Create_DAG_on_PANOS1.panos_ip_tag.this["web.web-2.dc1"] will be created
  + resource "panos_ip_tag" "this" {
      + id   = (known after apply)
      + ip   = "10.88.0.103"
      + tags = [
          + "web",
        ]
      + vsys = "vsys1"
    }

Plan: 2 to add, 0 to change, 0 to destroy.
module.Create_DAG_on_PANOS1.panos_ip_tag.this["web.web-1.dc1"]: Creating...
## ...
Apply complete! Resources: 2 added, 0 changed, 0 destroyed.
[INFO]  ctrl: task completed: task_name=Create_DAG_on_PANOS1
[INFO]  ctrl: all tasks completed once
[INFO]  api: starting server: port=8558
```

CTS continuously runs as a daemon and automatically executes the `Create_DAG_on_PANOS1` task when it detects changes to the `web` Consul service.

## Verify NIA automation workflow

In the Palo Alto Networks interface, click the **more…** link for your dynamic address group to verify the workflow.

![PAN NGFW Dynamic Address Group IP Addresses tab](/img/nia/palo_alto_ngfw_dynamic_address_group_addresses.png)

Any time Consul detects changes to your Consul service, CTS will automatically register or deregister the IP addresses tags in your Palo Alto NGFW's dynamic address group.

## Related resources

CTS helps you automatically update your network infrastructure when your upstream infrastructure changes or fails. In addition, you can extend CTS to support CI/CD operations including [blue-green and canary deployment by leveraging Terraform](/consul/tutorials/get-started-hcp/hcp-gs-canary-deployments) and service tags on Consul.

Check out the following resource to learn more about network infrastructure automation with CTS and Palo Alto.

- Learn more about the [Terraform NIA module for Palo Alto NGFW](https://registry.terraform.io/modules/PaloAltoNetworks/dag-nia/panos/latest)