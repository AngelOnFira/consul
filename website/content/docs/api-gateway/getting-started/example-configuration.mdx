---
layout: docs
page_title: Example Configuration
---

# Example Configuration

After `helm install` runs, by default the helm chart creates a `gatewayClass` and a `gatewayClassConfig` on your cluster. In order to see these newly created classes, you can run the following commands.

```shell-session
$ kubectl get gatewayClass consul-api-gateway -o yaml
```

```shell-session
$ kubectl get gatewayClassConfig consul-api-gateway -o yaml
```

The following example shows how to utilize the newly created `gatewayClass` and deploy a gateway object in the default namespace.

Note: If you want to run HTTPS you will need to follow the [instructions](https://kubernetes.io/docs/tasks/tls/managing-tls-in-a-cluster/)
to create a tls secret and update <YOUR_CERTIFICATE> and <YOUR_CERTIFICATE_NAMESPACE> with the values you created. If you don't
want to run https, simply delete the HTTPS `listener` from `example-gateway` and the `https` port from `example-service`.

<CodeBlockConfig filename="example.yaml">

```yaml
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: Gateway
metadata:
  name: example-gateway

spec:
  gatewayClassName: consul-api-gateway
  listeners:
  - allowedRoutes:
      namespaces:
        from: All
    name: https
    port: 443
    protocol: HTTPS
    tls:
      certificateRefs:
        - name: <YOUR_CERTIFICATE>
          namespace: <YOUR_CERTIFICATE_NAMESPACE>
  - allowedRoutes:
      namespaces:
        from: All
    name: http
    port: 80
    protocol: HTTP

---

apiVersion: consul.hashicorp.com/v1alpha1
kind: ServiceDefaults
metadata:
  name: example-service
  namespace: default
spec:
  protocol: http

---

apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: echo-service
  name: echo-service
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: echo-service
  template:
    metadata:
      labels:
        app: echo-service
      annotations:
        'consul.hashicorp.com/connect-inject': 'true'
    spec:
      containers:
      - image: hashicorp/http-echo
        args: ["-text", "'Hello, World'"]
        name: echo-service
        ports:
        - containerPort: 5678


---

apiVersion: v1
kind: Service
metadata:
  name: example-service

spec:
  selector:
    app: echo-service
  ports:
  - name: http
    targetPort: 5678
    port: 80
  - name: https
    targetPort: 5678
    port: 443

---

apiVersion: gateway.networking.k8s.io/v1alpha2
kind: HTTPRoute
metadata:
  name: example-route
  namespace: default

spec:
  parentRefs:
  - name: example-gateway
  rules:
  - backendRefs:
    - name: example-service
      kind: Service
      port: 5678

```
</CodeBlockConfig>

The above gateway configuration creates a gateway that explicitly allows routes from `All namespaces` to connect to the gateway. Additionally, it also creates a service named `example-http-service` that routes to any pod with the `app: example-service` label, and a `hashicorp/echo-service` pod for the service to route to. Finally, it creates an`HTTPRoute` named `example-route` to attach to `example-gateway`.

In order to apply this stack to your cluster save the above command to your local machine, and run the following command.

```shell-session
$ kubectl apply -f example.yaml
```

Check the gateway status with the following command.

```shell-session
$ kubectl get gateway example-gateway
```

When the output looks as follows your gateway is ready.

```log
example-gateway   consul-api-gateway   <YOUR_GATEWAY_ADDRESS>   True    24m
```

Make a note of the value populated in <YOUR_GATEWAY_ADDRESS>. Double check that your route successfully attached to the gateway by running the following command.

```shell-session
$ kubectl get httproute example-route -o yaml
```

If the status looks as follows

```yaml
    - conditions:
    - lastTransitionTime: "2022-05-09T20:25:34Z"
      message: Route accepted.
      observedGeneration: 1
      reason: Accepted
      status: "True"
      type: Accepted
    - lastTransitionTime: "2022-05-09T20:25:34Z"
      message: ResolvedRefs
      observedGeneration: 1
      reason: ResolvedRefs
      status: "True"
      type: ResolvedRefs
```

Your route bound successfully and you should be able to access your gateway by copy pasting the address populated into <YOUR_GATEWAY_ADDRESS>
in the previous step.


## Gotchas

### Not found errors
```log
'k8s: service default/example-service not found'
```

Usually this happens when the route was created before the service. Make sure that the service exists by running the following command>

```shell-session
$ kubectl get service example-service
```

And then delete and recreate the httproute.
```shell-session
$ kubectl delete httproute example-route
$ kubectl apply -f example.yaml
```

```log
'consul: service default/example-service not found'
```

This happens because the service hasn't been registered in consul. Usually this is because `connectInject` wasn't set
in the values.yaml when helm was installed...

```yaml
connectInject:
  enabled: true
```

...or the service was created before consul was ready. Try deleting and recreating the service.

```shell-session
$ kubectl delete service example-service
$ kubectl apply -f example.yaml
```
